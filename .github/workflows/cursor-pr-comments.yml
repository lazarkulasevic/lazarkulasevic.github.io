name: Cursor PR Comments

on:
  issue_comment:
    types: [created]

jobs:
  process-cursor-comment:
    name: Process /cursor comment
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/cursor')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Get PR details
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const repo = context.repo;
            
            const { data: pr } = await github.rest.pulls.get({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber
            });
            
            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_branch', pr.head.ref);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('comment_body', context.payload.comment.body);

      - name: Checkout PR branch
        run: |
          git fetch origin ${{ steps.pr_info.outputs.pr_branch }}
          git checkout ${{ steps.pr_info.outputs.pr_branch }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract prompt from comment
        id: extract_prompt
        run: |
          COMMENT="${{ steps.pr_info.outputs.comment_body }}"
          # Remove "/cursor" prefix and trim whitespace
          PROMPT=$(echo "$COMMENT" | sed 's|^/cursor||' | sed 's|^[[:space:]]*||' | sed 's|[[:space:]]*$||')
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Process with AI and apply changes
        id: ai_process
        env:
          PROMPT: ${{ steps.extract_prompt.outputs.prompt }}
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          PR_BRANCH: ${{ steps.pr_info.outputs.pr_branch }}
          BASE_BRANCH: ${{ steps.pr_info.outputs.base_branch }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_GITHUB_PERSONAL_API_KEY }}
        run: |
          node scripts/process-cursor-prompt.js

      - name: Create summary comment
        if: steps.ai_process.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const repo = context.repo;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: '✅ **Cursor processing complete!**\n\nChanges have been applied to this PR branch. Please review the commit and push if everything looks good.'
            });

      - name: Create error comment
        if: steps.ai_process.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const repo = context.repo;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: '❌ **Error processing Cursor prompt**\n\nPlease check the workflow logs for details.'
            });
